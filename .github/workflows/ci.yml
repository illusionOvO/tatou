name: CI
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov requests ruff
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Unit Tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          python -m pytest -v server/test --cov=server/src

      - name: Start Server (Docker)
        run: |
          if [ -f .env.example ]; then cp .env.example .env; else touch .env; fi
          docker compose up -d --build
          sleep 10  # 等待服务器启动

      - name: Run Fuzz Tests
        run: |
          python Fuzz_test/make_pdf.py  # 现场生成 PDF
          python Fuzz_test/fuzz_enhanced.py --url http://127.0.0.1:5000 --file Fuzz_test/Test.pdf